# File: app/_layout.tsx

### Summary
Root layout that initializes app providers and navigation. Now also initializes centralized logging early.

### Fixes Applied log
- problem: Logging was too verbose and hard to follow.
- solution: Imported `utils/logger` at the top so all console logs in the app respect the global log level.
- problem: Deep-link navigation to `/join/:code` in an incognito window sometimes stuck on initial load because the auth guard redirected before routing segments were ready.
- solution: In `RootLayoutNav`, detect the raw `window.location.pathname` and treat paths starting with `/join` as being on the join screen during the first auth check. This prevents premature redirects and allows invite pages to load unauthenticated.
- problem: `window.location.href` access in `getUrlParams()` functions crashed on React Native because `window.location` doesn't exist or doesn't have `href` property in native environments.
- solution: Added safety checks to verify `window.location` exists and has `href` before accessing it, and wrapped URL parsing in try-catch to handle React Native environments gracefully.
- problem: Status bar had a white background (`backgroundColor="#FFFFFF"`) that didn't match the gradient background used in the login screen, creating a visual mismatch.
- solution: Removed the `backgroundColor` prop and set `style="dark"` so the status bar is transparent (translucent defaults to true) and allows the gradient to show through naturally, while ensuring dark text/icons for visibility.
- problem: `/set-password` and `/reset-password` routes were being protected by auth guard, redirecting unauthenticated users to login page.
- solution: Added `inSetPasswordScreen` and `inResetPasswordScreen` checks to allow these public routes without authentication, and registered them in the Stack navigator.
- problem: Share links to Toki details pages were redirecting to explore page instead of the specific Toki. When authenticated users on login screen had `returnTo=/toki-details`, the code was setting redirection and navigating to `/(tabs)` instead of navigating directly to toki-details, causing the component to unmount.
- solution: 
  - Fixed the redirect logic to navigate directly to toki-details when `returnTo` is `/toki-details` instead of going through tabs
  - Added filtering to remove internal params (`screen`, `params`) and invalid values (`[object Object]`) from URL parameters
  - Added comprehensive logging to track the redirect flow
- **Problem**: After login with `returnTo=join&code=6I69YTSU`, the redirection was constructing `join?code=6I69YTSU` instead of `/join/6I69YTSU`, causing "This screen doesn't exist" error.
- **Solution**: Added special handling for join route redirection to construct `/join/[code]` path when `returnTo=join` and `code` is in params, in both the state redirection handler and direct redirection handler.
- **Problem**: Fast redirect (when tokens exist on login page) was redirecting to "join" instead of `/join/[code]`, causing routing errors.
- **Solution**: Added special handling in fast redirect logic to check if `effectiveReturnTo === 'join'` and `effectiveCode` exists, then construct `/join/${code}` path before redirecting.

### How Fixes Were Implemented
- Added `import '@/utils/logger'` as the first import so console patching happens before other modules run. This ensures existing `console.*` calls across the app are filtered by level.
- Updated the auth-check effect to:
  - Read `window.location.pathname` once and set `pathIsJoin`.
  - If `pathIsJoin` is true, skip the initial auth check entirely to avoid redirecting away.
  - Otherwise, proceed with debounced auth checks and redirects as before.
  - Result: Pasting an invite link like `http://localhost:8081/join/ABC123` immediately renders the join page; it loads public invite info and asks the user to log in only when needed.
- Fixed `getUrlParams()` functions (two instances) to:
  - Check if `window.location` exists and has `href` property before accessing it (web-only API).
  - Wrap `new URL()` parsing in try-catch block to gracefully handle React Native where URL parsing may fail.
  - Return empty object `{}` if any check fails, preventing crashes on native platforms.
- Fixed `window.location.pathname` access in `checkAuth()` function to use optional chaining (`window.location?.pathname`) for safe access on React Native.
- Updated `StatusBar` component configuration:
  - Changed `style="auto"` to `style="dark"` to explicitly set dark text/icons for light backgrounds.
  - Removed `backgroundColor` prop so the status bar is transparent (translucent defaults to `true`), allowing the gradient backgrounds (like the login screen's `#FFF1EB` to `#E5DCFF` gradient) to show through naturally.
  - This eliminates the white status bar background that was visually mismatched with the app's gradient backgrounds.
- Added password reset/set routes to public access:
  - Added `inSetPasswordScreen` and `inResetPasswordScreen` boolean checks that detect if the current route is `/set-password` or `/reset-password`.
  - Updated the auth guard condition to exclude these screens from redirecting to login.
  - Added `<Stack.Screen name="set-password" />` and `<Stack.Screen name="reset-password" />` to the Stack navigator.
  - Result: Users can now access password reset/set pages via email links without being redirected to login.
- Added debugging logs for deep linking issues:
  - **Initial auth check logging**: Logs current path, segments, effectiveReturnTo, urlParams, and effectiveOtherParams at the start of each auth check
  - **Redirect to tabs logging**: When authenticated users on login screen are redirected to `/(tabs)`, logs:
    - The condition that triggered the redirect
    - Current path and segments
    - All returnTo and parameter values
    - Warning if toki-details should be navigated to but tabs is used instead
  - **Fast redirect logging**: Enhanced existing fast redirect logs to show full redirect URL with all parameters
  - **Auth redirect logging**: Enhanced existing auth redirect logs to show the final redirect URL
  - These logs help identify why share links might redirect to explore page instead of toki-details page
- **Direct navigation fix**: When authenticated user is on login screen with `returnTo=/toki-details`, the code now navigates directly to toki-details with all parameters instead of:
  1. Setting redirection state
  2. Navigating to `/(tabs)`
  3. Relying on RedirectionGuard to redirect again
  - This prevents the toki-details component from mounting and then unmounting
  - For non-toki-details paths, still uses the redirection guard pattern
- **Parameter filtering**: Added filtering to remove internal Expo Router params (`screen`, `params`) and invalid stringified objects (`[object Object]`) from URL parameters in all redirect paths:
  - Fast redirect
  - Auth redirect (login screen)
  - Direct redirect (authenticated users)
  - User data redirect
- problem: Navigation to toki-details page was failing on native iOS app. The path detection relied on `window.location.pathname` which doesn't exist in React Native, causing the routing logic to fail to detect when users were navigating to toki-details. Additionally, parameter extraction was prioritizing `urlParams` (web-only) over `searchParams` (cross-platform), causing `tokiId` to be lost in native apps.
- solution: 
  - Created cross-platform `getCurrentPath()` helper function that uses `window.location.pathname` for web and builds path from `segments` for native
  - Updated parameter extraction to prioritize `searchParams` (from `useLocalSearchParams()`) which works on both platforms, with `urlParams` as fallback for web
  - Applied cross-platform parameter extraction to all toki-details navigation paths (unauthenticated redirect, authenticated redirect, fast redirect, user data redirect)
  - Fixed variable naming conflicts by renaming `URLSearchParams` instances to `queryString` to avoid shadowing the `searchParams` variable from `useLocalSearchParams()`
- problem: When app opened fresh from universal link (iOS), it showed "This screen doesn't exist" and lost query parameters. The `effectiveOtherParams` showed `"params": "[object Object]"` (stringified object) instead of actual params like `tokiId`. This happened because navigation was using query string form (`router.replace('/toki-details?tokiId=...')`) which Expo Router doesn't parse correctly. Additionally, the app was navigating immediately from the `notFoundArray` extraction (which had the path but no params) before the async `Linking.getInitialURL()` completed (which had the full URL with params).
- solution:
  - Implemented cross-platform initial URL capture: uses `sessionStorage` for web and `Linking.getInitialURL()` for native
  - Added `isWaitingForInitialUrl` state to track async URL capture on native
  - Added loading screen on native while waiting for initial URL
  - Updated URL extraction logic to prioritize `initialUrl` state, handle custom schemes (`tokimap://`), and extract query params from multiple sources
  - **Changed navigation to use object form**: Instead of `router.replace('/path?param=value')`, now uses `router.replace({ pathname: '/path', params: { param: 'value' } })` which ensures Expo Router properly receives and parses params
  - **Added wait logic on native**: If extraction finds a path but no params, and `initialUrl` is still `null` on native, the effect returns early without navigating. It waits for `initialUrl` to be set, then re-runs and extracts from the full URL with params. This prevents premature navigation without params, even if `isWaitingForInitialUrl` has already been set to `false` (which happens immediately after the async `Linking.getInitialURL()` completes).
  - Result: On native, the app shows a loading screen, waits for the full URL to be captured, extracts path and params, then navigates once with all data
- problem: When app opens fresh from universal link on real device, authenticated users were being redirected to explore page (tabs) instead of staying on the deep link page (e.g., toki-details). This happened because the auth check was running after the initial URL handler navigated to the deep link page, and it didn't recognize that authenticated users should stay on valid deep link pages.
- solution:
  - Added a new condition in the auth check to detect when authenticated users are on valid deep link pages (`toki-details`, `user-profile`, `join`)
  - If user is on a deep link page OR if initial URL handling is still in progress, the auth check returns early without redirecting
  - Only redirects authenticated users to tabs if they're on an unrecognized page AND initial URL handling is complete
  - This ensures that when app opens fresh from universal link, authenticated users stay on the target deep link page instead of being redirected to explore
- problem: When clicking notifications from the profile screen, users were sometimes redirected to `/exMap` (explore) instead of the intended notification destination. This happened because `window.location.pathname` could be stale during navigation transitions, causing the auth check to read an old path (like `/exMap`) and preserve it as `returnTo`, which then triggered a redirect to that stale path.
- solution:
  - Changed path detection to prefer `segments` over `window.location.pathname` since segments are more reliable during navigation transitions
  - Added validation to detect path mismatches between segments and window.location, preferring segments when they differ
  - Added check to detect race conditions: if user has tokens but `isAuthenticated` is false, don't preserve the path (just redirect to login and let fast redirect handle it)
  - Added validation to prevent preserving stale tab routes: if the path is a tab route (like `/exMap`, `/profile`) but doesn't match current segments, don't preserve it as `returnTo`
  - This prevents stale paths from being preserved and causing incorrect redirects when clicking notifications
- **Path detection fix**: Updated `getCurrentPath()` to prefer segments over `window.location.pathname`:
  - Segments are more reliable during navigation transitions
  - Added logging to detect mismatches between segments and window.location
  - When mismatch is detected, prefer segments path as it's more up-to-date
- **Race condition detection**: Added check before preserving paths as `returnTo`:
  - If user has tokens but `isAuthenticated` is false, it's likely a race condition
  - In this case, don't preserve the path - just redirect to login and let fast redirect handle it
  - This prevents stale paths from being preserved during authentication state transitions
- **Stale path validation**: Added validation to prevent preserving stale tab routes:
  - If path is a tab route (`/(tabs)`, `/exMap`, `/profile`, `/messages`) but doesn't match current segments
  - Don't preserve it as `returnTo` - just redirect to login without preserving path
  - This prevents incorrect redirects when clicking notifications from profile screen
- **Critical fix for intermittent redirects**: Added check to only respect `effectiveReturnTo` when on login screen:
  - When navigating from authenticated screens (like notifications), ignore stale `returnTo` in URL
  - The redirect logic at line 834 now checks `if (segments[0] !== 'login')` before processing `effectiveReturnTo`
  - This prevents intermittent redirects that happened when:
    - User clicks notification from profile screen
    - URL still has stale `returnTo=/exMap` from previous navigation
    - Auth check runs and sees `isAuthenticated && effectiveReturnTo` â†’ triggers redirect
  - Now the redirect only happens when actually on login screen, not when navigating from authenticated screens
  - This fixes the "works sometimes" issue by ensuring `returnTo` is only respected in legitimate redirect scenarios
- **Fix for notifications redirect issue**: Added all valid authenticated routes to the auth check:
  - Problem: When clicking notifications from profile screen, `/notifications` was being treated as an "unrecognized page" and redirecting to tabs
  - The auth check at line 761 only recognized deep link pages (`toki-details`, `user-profile`, `join`) but not regular authenticated routes
  - Solution: Added all valid authenticated routes to the check: `notifications`, `connections`, `chat`, `edit-profile`, `my-tokis`, `saved-tokis`
  - Now authenticated users can stay on these valid pages instead of being redirected to tabs
  - This fixes the "Maximum update depth exceeded" error that was caused by redirect loops
